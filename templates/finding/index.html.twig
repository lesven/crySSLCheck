{% extends 'base.html.twig' %}

{% block title %}TLS Monitor – Findings{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-check"></i> Findings</h2>
</div>

{# Filter #}
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" action="{{ path('finding_index') }}" class="row g-3 align-items-center">
            <div class="col-auto">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="current_run" name="current_run" value="1"
                           {{ currentRunOnly ? 'checked' : '' }} onchange="this.form.submit()">
                    <label class="form-check-label" for="current_run">Nur aktueller Run</label>
                </div>
            </div>
            <div class="col-auto">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="problems_only" name="problems_only" value="1"
                           {{ problemsOnly ? 'checked' : '' }} onchange="this.form.submit()">
                    <label class="form-check-label" for="problems_only">Nur Probleme anzeigen</label>
                </div>
            </div>
            <div class="col-auto">
                <noscript><button type="submit" class="btn btn-sm btn-primary">Filter anwenden</button></noscript>
            </div>
        </form>
    </div>
</div>

{% if findings is empty %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Keine Findings vorhanden.
    </div>
{% else %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Domain</th>
                    <th>Port</th>
                    <th>Finding-Typ</th>
                    <th>Details</th>
                    <th>Severity</th>
                    <th>Datum</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for finding in findings %}
                    {% set details = finding.details %}
                    <tr>
                        <td>{{ finding.domain.fqdn }}</td>
                        <td>{{ finding.domain.port }}</td>
                        <td>{{ finding.findingType }}</td>
                        <td>
                            {% if finding.findingType == 'OK' and details %}
                                <small>
                                    {% if details.protocol is defined %}<strong>TLS:</strong> {{ details.protocol }}<br>{% endif %}
                                    {% if details.cipher_name is defined %}
                                        <strong>Cipher:</strong> {{ details.cipher_name }}
                                        {% if details.cipher_bits is defined %}({{ details.cipher_bits }}-bit){% endif %}<br>
                                    {% endif %}
                                    {% if details.public_key_type is defined and details.public_key_bits is defined %}
                                        <strong>Key:</strong> {{ details.public_key_type }} {{ details.public_key_bits }} bits<br>
                                    {% endif %}
                                    {% if details.valid_to is defined %}
                                        <strong>Gültig bis:</strong> {{ details.valid_to }}
                                        {% if details.days_remaining is defined %}({{ details.days_remaining }}d){% endif %}
                                    {% endif %}
                                </small>
                            {% elseif finding.findingType == 'CERT_EXPIRY' and details.expiry_date is defined %}
                                <small>
                                    <strong>Läuft ab:</strong> {{ details.expiry_date }}
                                    {% if details.days_remaining is defined %}({{ details.days_remaining }} Tage){% endif %}
                                </small>
                            {% elseif finding.findingType == 'TLS_VERSION' and details.protocol is defined %}
                                <small>Unsicher: {{ details.protocol }}</small>
                            {% elseif finding.findingType == 'RSA_KEY_LENGTH' and details.key_bits is defined %}
                                <small>
                                    <strong>RSA-Schlüssellänge:</strong> {{ details.key_bits }} bits
                                    {% if details.message is defined %} — {{ details.message }}{% endif %}
                                </small>
                            {% elseif details.error is defined %}
                                <small class="text-muted">{{ details.error|slice(0, 100) }}</small>
                            {% else %}
                                <small class="text-muted">–</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ finding.severityBadgeClass }}">{{ finding.severity }}</span>
                        </td>
                        <td>{{ finding.checkedAt ? finding.checkedAt|date('Y-m-d H:i') : '' }}</td>
                        <td>
                            <span class="badge bg-{{ finding.statusBadgeClass }}">{{ finding.status }}</span>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Pagination #}
    {% if totalPages > 1 %}
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item {{ page <= 1 ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path('finding_index', {page: page - 1, problems_only: problemsOnly ? 1 : 0, current_run: currentRunOnly ? 1 : 0}) }}">
                        &laquo; Zurück
                    </a>
                </li>
                {% for i in 1..totalPages %}
                    <li class="page-item {{ i == page ? 'active' : '' }}">
                        <a class="page-link" href="{{ path('finding_index', {page: i, problems_only: problemsOnly ? 1 : 0, current_run: currentRunOnly ? 1 : 0}) }}">
                            {{ i }}
                        </a>
                    </li>
                {% endfor %}
                <li class="page-item {{ page >= totalPages ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path('finding_index', {page: page + 1, problems_only: problemsOnly ? 1 : 0, current_run: currentRunOnly ? 1 : 0}) }}">
                        Weiter &raquo;
                    </a>
                </li>
            </ul>
        </nav>
    {% endif %}

    <p class="text-muted text-center small">
        Zeige {{ findings|length }} von {{ totalCount }} Einträgen (Seite {{ page }} von {{ totalPages }})
    </p>
{% endif %}
{% endblock %}
